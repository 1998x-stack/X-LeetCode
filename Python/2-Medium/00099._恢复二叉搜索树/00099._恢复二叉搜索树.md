[99. 恢复二叉搜索树](https://leetcode.cn/problems/recover-binary-search-tree)

[ChatGPT](https://chat.openai.com/share/44ee4fab-064b-4d65-aa38-215132f22823)

---

## 1. 问题的内容
**1.1 题目描述**：
LeetCode上的题目99，"恢复二叉搜索树"，要求我们在不改变树结构的情况下，恢复一棵被错误交换了两个节点的二叉搜索树（BST）。我们需要找出并交换这两个节点，以恢复二叉搜索树的正确性。

**1.2 示例**：
假设有一个二叉搜索树，其中两个节点被错误地交换了。例如，输入:

```
   1
  / \
 2   3
```
在这棵树中，节点 2 和节点 1 被错误交换了，正确的树应该是节点 1 和节点 2 交换位置。

**1.3 提示**:
- 二叉搜索树的性质是：对于树中的任意节点，左子树上的所有节点的值都小于当前节点的值，右子树上的所有节点的值都大于当前节点的值。
- 可以通过中序遍历得到树中节点的值的序列，正常情况下这个序列应该是升序的。如果其中有两个节点被错误交换了，则这个序列中会存在两处不符合升序的地方。

## 2. 边界情况和约束

1. **树的大小**:
   - **空树**：如果树为空，没有需要交换的节点。
   - **只有一个节点**：只有一个节点的树不可能存在错误交换，因为没有其他节点可以与之交换。
   - **只有两个节点**：如果树只有两个节点，那么这两个节点就是被错误交换的节点。

2. **错误节点的位置**:
   - **相邻节点**：被交换的两个节点可能是相邻的，这意味着它们在中序遍历序列中是连续的。
   - **非相邻节点**：被交换的节点在树中可能不相邻，它们在中序遍历序列中不是连续的。

3. **特殊结构的树**:
   - **线性树**：所有节点都只有一个子节点的树，即形成一条线的树。在这种情况下，错误可能很容易被发现。
   - **完全二叉树**：每个节点都有两个子节点，直到最后一层。在这种树中，错误节点的查找可能涉及更多的节点。

4. **约束条件**:
   - **不改变树的结构**：我们需要恢复二叉搜索树，而不是通过重新构建树的结构来修复它。
   - **优化内存使用**：尽量不使用额外的空间，或者最小化额外空间的使用。
   - **执行效率**：应尽量优化算法，以在合理的时间内完成树的恢复。


## 3. 算法和策略
#### 算法步骤：

1. **中序遍历**:
   - 使用递归或迭代方式进行中序遍历，因为在二叉搜索树中，中序遍历的结果应为升序排列的序列。
   - 在遍历过程中，需要比较当前节点与前一个节点（我们称之为`prev`）的值，以便检测是否存在逆序对。

2. **检测逆序对**:
   - **第一个逆序对**：当我们第一次发现`current.val < prev.val`时，`prev`是第一个错误的节点。
   - **第二个逆序对**：如果我们再次发现`current.val < prev.val`，则`current`是第二个错误的节点。
   - 注意：如果整个树中只有一对逆序，则第一个错误节点为第一对逆序的第一个节点，第二个错误节点为同一对逆序的第二个节点。

3. **记录错误节点**:
   - 在遍历过程中，当检测到逆序对时，记录下这两个节点。如果找到第二个逆序对，更新第二个错误节点。

4. **交换错误节点的值**:
   - 在完成树的遍历并找到两个错误的节点后，交换这两个节点的值以恢复二叉搜索树的正确性。

#### 策略：

- **遍历方式选择**：考虑使用迭代方式进行中序遍历以优化空间复杂度，迭代方式可以通过栈实现，减少递归造成的栈空间使用。
- **优化存储**：只存储必要的节点引用，而不是整个节点值序列，以减少内存使用。
- **边界情况处理**：在算法开始之前，检查树是否为空或只包含一个节点，这些情况下无需进行任何操作。

#### 详细设计：

1. **初始化**：
   - 创建变量来存储`prev`（前一个节点），以及两个错误节点`first`和`second`。
   - 使用栈来帮助实现迭代的中序遍历。

2. **中序遍历迭代**：
   - 通过栈来控制遍历流程，模拟递归过程中的系统调用栈。
   - 在遍历时，持续比较当前节点和`prev`节点的值，以找出逆序对。

3. **逆序对处理**：
   - 当找到逆序对时，根据是否已经找到第一个逆序对来决定是记录为`first`还是`second`。

4. **恢复二叉搜索树**：
   - 在遍历完成后，如果找到了错误节点，交换它们的值。

---

